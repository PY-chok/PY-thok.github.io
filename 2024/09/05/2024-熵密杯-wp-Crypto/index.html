

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" href="/img/avatar.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#11d4b7">
  <meta name="author" content="PYthok-Ptk">
  <meta name="keywords" content="">
  
    <meta name="description" content="2024-熵密杯-wp-crypto很荣幸和学长一起去银川打了这场比赛，本人主要负责前几题，主要还是靠mix学长的审计和bartleby学长的超绝推导，最后拿下二等奖第七名。 虽然最后差一点ak，但是当时就算做出来最后一题因为没血也只能拿第六，所以也没什么所谓了 也见到了我非常喜欢的糖醋小鸡块师傅！ 银川连着下了四天的雨，但是羊肉很好吃。 当时去坐飞机甚至还满座升舱了，运气真好。 简单写写。 规则">
<meta property="og:type" content="article">
<meta property="og:title" content="2024-熵密杯-wp-Crypto">
<meta property="og:url" content="https://py-thok.github.io/2024/09/05/2024-%E7%86%B5%E5%AF%86%E6%9D%AF-wp-Crypto/index.html">
<meta property="og:site_name" content="Ptk!">
<meta property="og:description" content="2024-熵密杯-wp-crypto很荣幸和学长一起去银川打了这场比赛，本人主要负责前几题，主要还是靠mix学长的审计和bartleby学长的超绝推导，最后拿下二等奖第七名。 虽然最后差一点ak，但是当时就算做出来最后一题因为没血也只能拿第六，所以也没什么所谓了 也见到了我非常喜欢的糖醋小鸡块师傅！ 银川连着下了四天的雨，但是羊肉很好吃。 当时去坐飞机甚至还满座升舱了，运气真好。 简单写写。 规则">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://py-thok.github.io/pic/image-20240905144307852.png">
<meta property="og:image" content="https://py-thok.github.io/pic/image-20240905145811936.png">
<meta property="article:published_time" content="2024-09-05T05:57:27.000Z">
<meta property="article:modified_time" content="2024-09-05T07:41:45.239Z">
<meta property="article:author" content="PYthok-Ptk">
<meta property="article:tag" content="CTF">
<meta property="article:tag" content="Crypto">
<meta property="article:tag" content="Web">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://py-thok.github.io/pic/image-20240905144307852.png">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>2024-熵密杯-wp-Crypto - Ptk!</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"py-thok.github.io","root":"/","version":"1.9.5-a","typing":{"enable":true,"typeSpeed":50,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="Ptk!" type="application/atom+xml">
</head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Ptk!</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/banner.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="2024-熵密杯-wp-Crypto"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2024-09-05 13:57" pubdate>
          2024年9月5日 下午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          29k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          246 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">2024-熵密杯-wp-Crypto</h1>
            
            
              <div class="markdown-body">
                
                <h1 id="2024-熵密杯-wp-crypto"><a href="#2024-熵密杯-wp-crypto" class="headerlink" title="2024-熵密杯-wp-crypto"></a>2024-熵密杯-wp-crypto</h1><p>很荣幸和学长一起去银川打了这场比赛，本人主要负责前几题，主要还是靠mix学长的审计和bartleby学长的超绝推导，最后拿下二等奖第七名。</p>
<p>虽然最后差一点ak，但是当时就算做出来最后一题因为没血也只能拿第六，所以也没什么所谓了</p>
<p>也见到了我非常喜欢的糖醋小鸡块师傅！</p>
<p>银川连着下了四天的雨，但是羊肉很好吃。</p>
<p>当时去坐飞机甚至还满座升舱了，运气真好。</p>
<p>简单写写。</p>
<h4 id="规则"><a href="#规则" class="headerlink" title="规则"></a>规则</h4><p>当时忘记把比赛规则带出来了，印象里是三道初始谜题，然后做出来任意一道可以进入第二轮，第二轮有两条路径，flag1-&gt;flag2,flag3-&gt;flag4，必须把flag2和flag4都做出来才能到最终环节，最终环节就是一个签名的伪造，当时就是卡在最终环节一直没签上。</p>
<h4 id="初始谜题1"><a href="#初始谜题1" class="headerlink" title="初始谜题1"></a>初始谜题1</h4><p>其实说实话，熵密杯的题和一般的ctf题目非常不一样，比如我还没有见到用sympy写题面的题目。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> sympy <span class="hljs-keyword">import</span> Mod, Integer<br><span class="hljs-keyword">from</span> sympy.core.numbers <span class="hljs-keyword">import</span> mod_inverse<br><br><span class="hljs-keyword">from</span> Crypto.Util.number <span class="hljs-keyword">import</span> long_to_bytes<br><span class="hljs-comment"># 模数</span><br>N_HEX = <span class="hljs-string">&quot;FFFFFFFEFFFFFFFFFFFFFFFFFFFFFFFF7203DF6B21C6052B53BBF40939D54123&quot;</span><br>MODULUS = Integer(<span class="hljs-built_in">int</span>(N_HEX, <span class="hljs-number">16</span>))<br>MSG_PREFIX = <span class="hljs-string">&quot;CryptoCup message:&quot;</span><br><br><br><span class="hljs-comment"># 加密函数</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">encrypt_message</span>(<span class="hljs-params">message, key</span>):<br>    <span class="hljs-comment"># 添加前缀</span><br>    message_with_prefix = MSG_PREFIX + message<br>    message_bytes = message_with_prefix.encode(<span class="hljs-string">&#x27;utf-8&#x27;</span>)<br>    message_len = <span class="hljs-built_in">len</span>(message_bytes)<br>    num_blocks = (message_len + <span class="hljs-number">15</span>) // <span class="hljs-number">16</span><br>    blocks = [message_bytes[i * <span class="hljs-number">16</span>:(i + <span class="hljs-number">1</span>) * <span class="hljs-number">16</span>] <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(num_blocks)]<br><br>    <span class="hljs-comment"># 进行0填充</span><br>    blocks[-<span class="hljs-number">1</span>] = blocks[-<span class="hljs-number">1</span>].ljust(<span class="hljs-number">16</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br><br>    encrypted_blocks = []<br><br>    k = key<br><br>    <span class="hljs-comment"># 加密每个分组</span><br>    <span class="hljs-keyword">for</span> block <span class="hljs-keyword">in</span> blocks:<br>        block_int = <span class="hljs-built_in">int</span>.from_bytes(block, byteorder=<span class="hljs-string">&#x27;big&#x27;</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;block_int &quot;</span>,block_int)<br>        encrypted_block_int = Mod(block_int * k, MODULUS)<br>        encrypted_blocks.append(encrypted_block_int)<br>        k += <span class="hljs-number">1</span>  <span class="hljs-comment"># 密钥自增1</span><br><br>    <span class="hljs-built_in">print</span>(encrypted_blocks)<br>    <br><br>    encrypted_list = []<br>    <span class="hljs-comment"># 将加密后的分组连接成最终的密文</span><br>    encrypted_list.append(<br>        [<span class="hljs-built_in">int</span>(block_int).to_bytes(<span class="hljs-number">32</span>, byteorder=<span class="hljs-string">&#x27;big&#x27;</span>) <span class="hljs-keyword">for</span> block_int <span class="hljs-keyword">in</span> encrypted_blocks]<br>    )<br><br>    <span class="hljs-keyword">return</span> encrypted_list<br><br><br><span class="hljs-comment"># 解密函数</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">decrypt_message</span>(<span class="hljs-params">encrypted_message, key</span>):<br>    num_blocks = <span class="hljs-built_in">len</span>(encrypted_message) // <span class="hljs-number">32</span><br>    blocks = [encrypted_message[i * <span class="hljs-number">32</span>:(i + <span class="hljs-number">1</span>) * <span class="hljs-number">32</span>] <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(num_blocks)]<br><br>    decrypted_blocks = []<br><br>    k = key<br><br>    <span class="hljs-comment"># 解密每个分组</span><br>    <span class="hljs-keyword">for</span> block <span class="hljs-keyword">in</span> blocks:<br>        block_int = <span class="hljs-built_in">int</span>.from_bytes(block, byteorder=<span class="hljs-string">&#x27;big&#x27;</span>)<br>        key_inv = mod_inverse(k, MODULUS)<br>        decrypted_block_int = Mod(block_int * key_inv, MODULUS)<br>        decrypted_blocks.append(decrypted_block_int)<br>        k += <span class="hljs-number">1</span>  <span class="hljs-comment"># 密钥自增1</span><br><br>    <span class="hljs-comment"># 将解密后的分组连接成最终的明文</span><br>    decrypted_message = <span class="hljs-string">b&#x27;&#x27;</span>.join(<br>        long_to_bytes(<span class="hljs-built_in">int</span>(block_int)) <span class="hljs-keyword">for</span> block_int <span class="hljs-keyword">in</span> decrypted_blocks<br>    )<br><br>    <span class="hljs-comment"># 去除前缀</span><br>    <span class="hljs-keyword">if</span> decrypted_message.startswith(MSG_PREFIX.encode(<span class="hljs-string">&#x27;utf-8&#x27;</span>)):<br>        decrypted_message = decrypted_message[<span class="hljs-built_in">len</span>(MSG_PREFIX):]<br><br>    <span class="hljs-keyword">return</span> decrypted_message<br><br><br><span class="hljs-comment"># 测试</span><br>initial_key = Integer(<span class="hljs-number">0x123456789ABCDEF0123456789ABCDEF0123456789ABCDEF0123456789ABCDEF0</span>)<br>message = <span class="hljs-string">&quot;Hello, this is a test message.asasfaefaasasaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&quot;</span><br><span class="hljs-comment">#print(&quot;Original Message:&quot;, message)</span><br><br><span class="hljs-comment"># 加密</span><br>encrypted_message = encrypt_message(message, initial_key)<br><span class="hljs-comment">#print(&quot;Encrypted Message (hex):&quot;, encrypted_message.hex())</span><br><span class="hljs-built_in">print</span>(encrypted_message)<br><span class="hljs-comment"># 解密</span><br>decrypted_message = decrypt_message(encrypted_message, initial_key)<br><span class="hljs-comment">#print(&quot;Decrypted Message:&quot;, decrypted_message)</span><br><br><br>ciphertext = long_to_bytes(<span class="hljs-number">0x5cae321c794c785089ccebc7fcdf834937857ee003b8e84a61392ddc774cfc16a7e0ca4268d31c0db6f993431df2e180e4ede0d2f6e51cd503c4dfc0c059a09610478208399e45679cad7651c1dd1060aad3137dc0d464ac67e4b776266895a5f4d760d64ed46b7e2302793ba366fb4d3f97abfa9f88b9a9329902764d555cc1</span>)<br><span class="hljs-built_in">print</span>(encrypt_message(<span class="hljs-string">&#x27;&#x27;</span>,initial_key))<br><span class="hljs-built_in">print</span>(encrypt_message(<span class="hljs-string">&#x27;0&#x27;</span>,initial_key))<br><br><br></code></pre></td></tr></table></figure>

<p>当时看的时候没什么感觉，感觉可能是格？后来队友提醒说这个部分明文是已知的，这才恍然大悟，可以直接解出key，然后后面就是简单的求逆的过程。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#flag1</span><br><span class="hljs-keyword">from</span> sympy <span class="hljs-keyword">import</span> Mod, Integer<br><span class="hljs-keyword">from</span> sympy.core.numbers <span class="hljs-keyword">import</span> mod_inverse<br><br><span class="hljs-keyword">from</span> Crypto.Util.number <span class="hljs-keyword">import</span> *<br>cipher = <span class="hljs-number">0x5cae321c794c785089ccebc7fcdf834937857ee003b8e84a61392ddc774cfc16a7e0ca4268d31c0db6f993431df2e180e4ede0d2f6e51cd503c4dfc0c059a09610478208399e45679cad7651c1dd1060aad3137dc0d464ac67e4b776266895a5f4d760d64ed46b7e2302793ba366fb4d3f97abfa9f88b9a9329902764d555cc1</span><br>N_HEX = <span class="hljs-number">0xFFFFFFFEFFFFFFFFFFFFFFFFFFFFFFFF7203DF6B21C6052B53BBF40939D54123</span><br><br>initial_key = Integer(<span class="hljs-number">0x123456789ABCDEF0123456789ABCDEF0123456789ABCDEF0123456789ABCDEF0</span>)<br>a = <span class="hljs-number">89652660640613347754090896429354803559</span><br>b = <span class="hljs-number">37681243689413481885669644652084398160214259040017619160297065760370037876043</span><br><span class="hljs-built_in">print</span>((b*inverse(a,N_HEX))%N_HEX)<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">int</span>(initial_key))<br><br><br>given_cipher = <span class="hljs-number">0x5cae321c794c785089ccebc7fcdf834937857ee003b8e84a61392ddc774cfc16a7e0ca4268d31c0db6f993431df2e180e4ede0d2f6e51cd503c4dfc0c059a09610478208399e45679cad7651c1dd1060aad3137dc0d464ac67e4b776266895a5f4d760d64ed46b7e2302793ba366fb4d3f97abfa9f88b9a9329902764d555cc1</span><br>cipher_byte = long_to_bytes(given_cipher)<br>num_blocks = <span class="hljs-built_in">len</span>(cipher_byte) // <span class="hljs-number">32</span><br>blocks = [cipher_byte[i * <span class="hljs-number">32</span>:(i + <span class="hljs-number">1</span>) * <span class="hljs-number">32</span>] <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(num_blocks)]<br>block_int = [bytes_to_long(i) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> blocks]<br><span class="hljs-built_in">print</span>(block_int)<br>a = <span class="hljs-number">89652660640613347754090896429354803559</span><br><span class="hljs-built_in">print</span>(block_int[<span class="hljs-number">0</span>]*inverse(a,N_HEX)%N_HEX)<br>hidekey = block_int[<span class="hljs-number">0</span>]*inverse(a,N_HEX)%N_HEX<br><br>N_HEX = <span class="hljs-string">&quot;FFFFFFFEFFFFFFFFFFFFFFFFFFFFFFFF7203DF6B21C6052B53BBF40939D54123&quot;</span><br>MODULUS = Integer(<span class="hljs-built_in">int</span>(N_HEX, <span class="hljs-number">16</span>))<br>MSG_PREFIX = <span class="hljs-string">&quot;CryptoCup message:&quot;</span><br><br><span class="hljs-comment"># 解密函数</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">decrypt_message</span>(<span class="hljs-params">encrypted_message, key</span>):<br>    num_blocks = <span class="hljs-built_in">len</span>(encrypted_message) // <span class="hljs-number">32</span><br>    blocks = [encrypted_message[i * <span class="hljs-number">32</span>:(i + <span class="hljs-number">1</span>) * <span class="hljs-number">32</span>] <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(num_blocks)]<br><br>    decrypted_blocks = []<br><br>    k = key<br><br>    <span class="hljs-comment"># 解密每个分组</span><br>    <span class="hljs-keyword">for</span> block <span class="hljs-keyword">in</span> blocks:<br>        block_int = <span class="hljs-built_in">int</span>.from_bytes(block, byteorder=<span class="hljs-string">&#x27;big&#x27;</span>)<br>        key_inv = mod_inverse(k, MODULUS)<br>        decrypted_block_int = Mod(block_int * key_inv, MODULUS)<br>        decrypted_blocks.append(decrypted_block_int)<br>        k += <span class="hljs-number">1</span>  <span class="hljs-comment"># 密钥自增1</span><br><br>    <span class="hljs-comment"># 将解密后的分组连接成最终的明文</span><br>    decrypted_message = <span class="hljs-string">b&#x27;&#x27;</span>.join(<br>        long_to_bytes(<span class="hljs-built_in">int</span>(block_int)) <span class="hljs-keyword">for</span> block_int <span class="hljs-keyword">in</span> decrypted_blocks<br>    )<br><br>    <span class="hljs-comment"># 去除前缀</span><br>    <span class="hljs-keyword">if</span> decrypted_message.startswith(MSG_PREFIX.encode(<span class="hljs-string">&#x27;utf-8&#x27;</span>)):<br>        decrypted_message = decrypted_message[<span class="hljs-built_in">len</span>(MSG_PREFIX):]<br><br>    <span class="hljs-keyword">return</span> decrypted_message<br><br><span class="hljs-built_in">print</span>(decrypt_message(cipher_byte,hidekey))<br></code></pre></td></tr></table></figure>

<p>简单解密完之后是一串字符，然后用他给的client端提交即可。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python">验证通过<br>flag&#123;8FSPTfuRIdOIxpoWRrXEBph93le6GjEv&#125;<br>gitea账号：giteauser2024<br>gitea口令：S(*HD^WY63y89TY71<br>提示：gitea账号和口令用于登录第二环节的gitea服务器，请注意保存！<br></code></pre></td></tr></table></figure>

<h4 id="初始谜题2"><a href="#初始谜题2" class="headerlink" title="初始谜题2"></a>初始谜题2</h4><p>sm3长度扩展攻击，包括md类的所有散列函数都会有这种问题。</p>
<p>其实之前在数信杯做过这道题了，但是之前没出，保存的脚本在比赛的时候死活用不上，最后一个人熬到12点硬看源码做出来了，当时10多人出，没拿到血还是很可惜。</p>
<p>简单分析一下源码吧。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">sm3_hash</span>(<span class="hljs-params">msg</span>):<br>    <span class="hljs-comment"># print(msg)</span><br>    len1 = <span class="hljs-built_in">len</span>(msg)<br>    reserve1 = len1 % <span class="hljs-number">64</span><br>    msg.append(<span class="hljs-number">0x80</span>)<br>    reserve1 = reserve1 + <span class="hljs-number">1</span><br>    <span class="hljs-comment"># 56-64, add 64 byte</span><br>    range_end = <span class="hljs-number">56</span><br>    <span class="hljs-keyword">if</span> reserve1 &gt; range_end:<br>        range_end = range_end + <span class="hljs-number">64</span><br><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(reserve1, range_end):<br>        msg.append(<span class="hljs-number">0x00</span>)<br><br>    bit_length = (len1) * <span class="hljs-number">8</span><br>    bit_length_str = [bit_length % <span class="hljs-number">0x100</span>]<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>        bit_length = <span class="hljs-built_in">int</span>(bit_length / <span class="hljs-number">0x100</span>)<br>        bit_length_str.append(bit_length % <span class="hljs-number">0x100</span>)<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">8</span>):<br>        msg.append(bit_length_str[<span class="hljs-number">7</span>-i])<br><br>    group_count = <span class="hljs-built_in">round</span>(<span class="hljs-built_in">len</span>(msg) / <span class="hljs-number">64</span>)<br><br>    B = []<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, group_count):<br>        B.append(msg[i*<span class="hljs-number">64</span>:(i+<span class="hljs-number">1</span>)*<span class="hljs-number">64</span>])<br><br>    V = []<br>    V.append(IV)<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, group_count):<br>        V.append(sm3_cf(V[i], B[i]))<br><br>    y = V[i+<span class="hljs-number">1</span>]<br>    result = <span class="hljs-string">&quot;&quot;</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> y:<br>        result = <span class="hljs-string">&#x27;%s%08x&#x27;</span> % (result, i)<br>    <span class="hljs-keyword">return</span> result<br></code></pre></td></tr></table></figure>

<p>大概就是说如果明文大于等于56字节就会分块，但是他的这一次的hash值是由上一块的hash值和这一块明文共同决定的。</p>
<p>$${hash}<em>i &#x3D; CF({hash}</em>{i-1},{plain}_{i-1})$$</p>
<p>所以说如果上一块明文和上一块的hash都是已知的，那么我们可以扩展他的长度，来推断出下一块的hash以及最终的$sm3(plain)$。</p>
<p>题目：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> binascii<br><span class="hljs-keyword">from</span> gmssl <span class="hljs-keyword">import</span> sm3<br><br><br><span class="hljs-comment"># 读取HMAC key文件</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">read_hmac_key</span>(<span class="hljs-params">file_path</span>):<br>    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(file_path, <span class="hljs-string">&#x27;rb&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>        hmac_key = f.read().strip()<br>    <span class="hljs-keyword">return</span> hmac_key<br><br><br><span class="hljs-comment"># 生成token</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">generate_token</span>(<span class="hljs-params">hmac_key, counter</span>):<br>    <span class="hljs-comment"># 如果HMAC_KEY长度不足32字节，则在末尾补0，超过64字节则截断</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(hmac_key) &lt; <span class="hljs-number">32</span>:<br>        hmac_key = hmac_key.ljust(<span class="hljs-number">32</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>    <span class="hljs-keyword">elif</span> <span class="hljs-built_in">len</span>(hmac_key) &gt; <span class="hljs-number">32</span>:<br>        hmac_key = hmac_key[:<span class="hljs-number">32</span>]<br><br>    <span class="hljs-comment"># 将计数器转换为字节表示</span><br>    counter_bytes = counter.to_bytes((counter.bit_length() + <span class="hljs-number">7</span>) // <span class="hljs-number">8</span>, <span class="hljs-string">&#x27;big&#x27;</span>)<br>    <span class="hljs-comment"># print(&quot;counter_bytes:&quot;, binascii.hexlify(counter_bytes))</span><br><br>    tobe_hashed = <span class="hljs-built_in">bytearray</span>(hmac_key + counter_bytes)<br><br>    <span class="hljs-comment"># print(&quot;tobe_hashed:&quot;, binascii.hexlify(tobe_hashed))</span><br><br>    <span class="hljs-comment"># 使用SM3算法计算哈希值</span><br>    sm3_hash = sm3.sm3_hash(tobe_hashed)<br><br>    <span class="hljs-comment"># 将SM3的哈希值转换为十六进制字符串作为token</span><br>    token = sm3_hash<br><br>    <span class="hljs-keyword">return</span> token<br><br><br>current_counter = <span class="hljs-number">0</span><br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">verify_token</span>(<span class="hljs-params">hmac_key, counter, token</span>):<br>    <span class="hljs-comment"># 生成token</span><br>    generated_token = generate_token(hmac_key, counter)<br>    <span class="hljs-keyword">global</span> current_counter<br>    <span class="hljs-comment"># 比较生成的token和输入的token是否相同</span><br>    <span class="hljs-keyword">if</span> generated_token == token:<br>        <span class="hljs-keyword">if</span> counter &amp; <span class="hljs-number">0xFFFFFFFF</span> &gt; current_counter:<br>            current_counter = counter &amp; <span class="hljs-number">0xFFFFFFFF</span><br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;current_counter: &quot;</span>, <span class="hljs-built_in">hex</span>(current_counter))<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Success&quot;</span><br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Error: counter must be increasing&quot;</span><br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Error: token not match&quot;</span><br><br><br><span class="hljs-comment"># 假设HMAC key文件路径</span><br>hmac_key_file = <span class="hljs-string">&#x27;hmac_key.txt&#x27;</span><br><span class="hljs-comment"># 假设计数器值</span><br>counter = <span class="hljs-number">0x12345678</span><br><br><span class="hljs-comment"># 读取HMAC key</span><br>hmac_key = read_hmac_key(hmac_key_file)<br><br><span class="hljs-comment"># 生成token</span><br>token = generate_token(hmac_key, counter)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Generated token:&quot;</span>, token)<br><span class="hljs-built_in">print</span>(verify_token(hmac_key, counter, token))<br><br></code></pre></td></tr></table></figure>

<p>在这个题目里其实有一个要求就是counter必须递增，这看起来很难其实只需要让最后的明文是\xff*8即可。</p>
<p>简单上个exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> gmssl <span class="hljs-keyword">import</span> sm3<br><span class="hljs-keyword">import</span> binascii<br><span class="hljs-keyword">from</span> math <span class="hljs-keyword">import</span> ceil<br><span class="hljs-keyword">from</span> Crypto.Util.number <span class="hljs-keyword">import</span> *<br>rotl = <span class="hljs-keyword">lambda</span> x, n:((x &lt;&lt; n) &amp; <span class="hljs-number">0xffffffff</span>) | ((x &gt;&gt; (<span class="hljs-number">32</span> - n)) &amp; <span class="hljs-number">0xffffffff</span>)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">turn</span>(<span class="hljs-params">a</span>):<br>    vectors = []<br>    <span class="hljs-keyword">for</span> r <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(a), <span class="hljs-number">8</span>):<br>        vectors.append(<span class="hljs-built_in">int</span>(a[r:r + <span class="hljs-number">8</span>], <span class="hljs-number">16</span>))<br>    <span class="hljs-keyword">return</span> (vectors)<br>msg = <span class="hljs-built_in">bytearray</span>(<span class="hljs-string">b&#x27;testtesttesttesttesttesttesttesttest&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">xxx</span>(<span class="hljs-params">a</span>):<br>    result = <span class="hljs-string">&quot;&quot;</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> a:<br>        result = <span class="hljs-string">&#x27;%s%08x&#x27;</span> % (result, i)<br>    <span class="hljs-keyword">return</span> result<br><br>a = (sm3.sm3_hash(msg))<br><span class="hljs-comment">#hmackey+counter = 32+4</span><br>given_hash = <span class="hljs-string">&quot;e965992687d956f6c38748bc7334a98a8e65530ace4742ea88ecdebd65fe3cc9&quot;</span><br><br>counter = <span class="hljs-number">0x79209583</span><br>my_B = <span class="hljs-built_in">bytearray</span>(<span class="hljs-string">b&#x27;\xff\xff\xff\xff\x80\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x02 &#x27;</span>)<br><br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;!!!!&quot;</span>,xxx(sm3.sm3_cf(turn(given_hash),my_B)))<br><span class="hljs-comment">#5bfa469312fc46e45fb27a492b6394b2d830aa13d29384edff66418148914c2e</span><br><span class="hljs-built_in">print</span>((sm3.sm3_hash(<span class="hljs-built_in">bytearray</span>(<span class="hljs-string">b&#x27;testtesttesttesttesttesttesttesttest\x80\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01 \xff\xff\xff\xff&#x27;</span>))))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(bytes_to_long(<span class="hljs-string">b&#x27;testtesttesttesttesttesttesttest\x75\xa5\xcd\xe4\x80\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01 \xff\xff\xff\xff&#x27;</span>)))<br></code></pre></td></tr></table></figure>

<h4 id="初始谜题3"><a href="#初始谜题3" class="headerlink" title="初始谜题3"></a>初始谜题3</h4><p>这题就是一个lwe，但是是学长做的，后来看了发现e只有2**16，所以是完全可以爆破的。</p>
<p>所以把e爆破出来直接解方程就出了，当时做出来的人也很多。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> sympy <span class="hljs-keyword">as</span> sp<br><span class="hljs-keyword">import</span> random<br><br><span class="hljs-comment"># 设置参数</span><br>n = <span class="hljs-number">16</span>  <span class="hljs-comment"># 向量长度</span><br>q = <span class="hljs-number">251</span>  <span class="hljs-comment"># 模数</span><br><br><span class="hljs-comment"># 生成随机噪声向量e</span><br>e = sp.Matrix(sp.randMatrix(n, <span class="hljs-number">1</span>, <span class="hljs-built_in">min</span>=<span class="hljs-number">0</span>, <span class="hljs-built_in">max</span>=<span class="hljs-number">1</span>))  <span class="hljs-comment"># 噪声向量</span><br><br><span class="hljs-comment"># 生成随机n维私钥向量s和n*n矩阵A</span><br>s = sp.Matrix(sp.randMatrix(n, <span class="hljs-number">1</span>, <span class="hljs-built_in">min</span>=<span class="hljs-number">0</span>, <span class="hljs-built_in">max</span>=q - <span class="hljs-number">1</span>))  <span class="hljs-comment"># 私钥向量</span><br>Temp = sp.Matrix(sp.randMatrix(n, n, <span class="hljs-built_in">min</span>=<span class="hljs-number">0</span>, <span class="hljs-built_in">max</span>=q - <span class="hljs-number">1</span>))  <span class="hljs-comment"># 中间变量矩阵Temp</span><br>A = Temp.inv_mod(q)  <span class="hljs-comment"># 计算矩阵Temp在模 q 下的逆矩阵作为A</span><br><br><span class="hljs-comment"># 计算n维公钥向量b</span><br>b = (A * s + e) % q  <span class="hljs-comment"># 公钥向量b = A * s + e</span><br><br><br><span class="hljs-comment"># 加密函数</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">encrypt</span>(<span class="hljs-params">message, A, b</span>):<br>    m_bin = <span class="hljs-built_in">bin</span>(message)[<span class="hljs-number">2</span>:].zfill(n)  <span class="hljs-comment"># 将消息转换为16比特的二进制字符串</span><br>    m = sp.Matrix([<span class="hljs-built_in">int</span>(bit) <span class="hljs-keyword">for</span> bit <span class="hljs-keyword">in</span> m_bin])  <span class="hljs-comment"># 转换为SymPy矩阵</span><br>    x = sp.Matrix(sp.randMatrix(n, n, <span class="hljs-built_in">min</span>=<span class="hljs-number">0</span>, <span class="hljs-built_in">max</span>=q // (n * <span class="hljs-number">4</span>)))  <span class="hljs-comment"># 随机产生一个n*n的矩阵x</span><br>    e1 = sp.Matrix(sp.randMatrix(n, <span class="hljs-number">1</span>, <span class="hljs-built_in">min</span>=<span class="hljs-number">0</span>, <span class="hljs-built_in">max</span>=<span class="hljs-number">1</span>))  <span class="hljs-comment"># 随机产生一个n维噪声向量e</span><br>    c1 = (x * A) % q  <span class="hljs-comment"># 密文部分c1 =   x * A</span><br>    c2 = (x * b + e1 + m * (q // <span class="hljs-number">2</span>)) % q  <span class="hljs-comment"># 密文部分c2 = x * b + e1 + m * q/2</span><br>    <span class="hljs-keyword">return</span> c1, c2<br><br><br><span class="hljs-comment"># 解密函数</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">decrypt</span>(<span class="hljs-params">c1, c2, s</span>):<br>    m_dec = (c2 - c1 * s) % q<br>    m_rec = m_dec.applyfunc(<span class="hljs-keyword">lambda</span> x: <span class="hljs-built_in">round</span>(<span class="hljs-number">2</span> * x / q) % <span class="hljs-number">2</span>)  <span class="hljs-comment"># 还原消息</span><br>    m_bin = <span class="hljs-string">&#x27;&#x27;</span>.join([<span class="hljs-built_in">str</span>(bit) <span class="hljs-keyword">for</span> bit <span class="hljs-keyword">in</span> m_rec])  <span class="hljs-comment"># 将SymPy矩阵转换为二进制字符串</span><br>    m_rec_int = <span class="hljs-built_in">int</span>(m_bin, <span class="hljs-number">2</span>)  <span class="hljs-comment"># 将二进制字符串转换为整数</span><br>    <span class="hljs-keyword">return</span> m_rec_int<br><br><br><span class="hljs-comment"># 测试加解密</span><br>message = random.randint(<span class="hljs-number">0</span>, <span class="hljs-number">2</span> ** n - <span class="hljs-number">1</span>)  <span class="hljs-comment"># 要加密的消息，随机生成一个16比特整数</span><br>c1, c2 = encrypt(message, A, b)  <span class="hljs-comment"># 加密</span><br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;原始消息: &quot;</span>, message)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;公钥A=sp.&quot;</span>, A)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;公钥b=sp.&quot;</span>, b)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;密文c1=sp.&quot;</span>, c1)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;密文c2=sp.&quot;</span>, c2)<br><br>decrypted_message = decrypt(c1, c2, s)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;解密后的消息: &quot;</span>, decrypted_message)  <span class="hljs-comment"># 输出解密后的消息</span><br></code></pre></td></tr></table></figure>



<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs python">q = <span class="hljs-number">251</span><br>G = GF(q)<br>A = Matrix(G,[[<span class="hljs-number">221</span>, <span class="hljs-number">127</span>, <span class="hljs-number">167</span>, <span class="hljs-number">140</span>, <span class="hljs-number">199</span>, <span class="hljs-number">232</span>, <span class="hljs-number">222</span>, <span class="hljs-number">196</span>, <span class="hljs-number">1</span>, <span class="hljs-number">246</span>, <span class="hljs-number">49</span>, <span class="hljs-number">165</span>, <span class="hljs-number">59</span>, <span class="hljs-number">97</span>, <span class="hljs-number">206</span>, <span class="hljs-number">122</span>], [<span class="hljs-number">109</span>, <span class="hljs-number">186</span>, <span class="hljs-number">186</span>, <span class="hljs-number">138</span>, <span class="hljs-number">216</span>, <span class="hljs-number">115</span>, <span class="hljs-number">65</span>, <span class="hljs-number">163</span>, <span class="hljs-number">139</span>, <span class="hljs-number">166</span>, <span class="hljs-number">186</span>, <span class="hljs-number">108</span>, <span class="hljs-number">235</span>, <span class="hljs-number">26</span>, <span class="hljs-number">146</span>, <span class="hljs-number">50</span>], [<span class="hljs-number">106</span>, <span class="hljs-number">74</span>, <span class="hljs-number">19</span>, <span class="hljs-number">10</span>, <span class="hljs-number">111</span>, <span class="hljs-number">88</span>, <span class="hljs-number">10</span>, <span class="hljs-number">142</span>, <span class="hljs-number">148</span>, <span class="hljs-number">74</span>, <span class="hljs-number">84</span>, <span class="hljs-number">44</span>, <span class="hljs-number">76</span>, <span class="hljs-number">125</span>, <span class="hljs-number">135</span>, <span class="hljs-number">48</span>], [<span class="hljs-number">138</span>, <span class="hljs-number">24</span>, <span class="hljs-number">193</span>, <span class="hljs-number">190</span>, <span class="hljs-number">12</span>, <span class="hljs-number">181</span>, <span class="hljs-number">229</span>, <span class="hljs-number">44</span>, <span class="hljs-number">48</span>, <span class="hljs-number">246</span>, <span class="hljs-number">115</span>, <span class="hljs-number">1</span>, <span class="hljs-number">33</span>, <span class="hljs-number">8</span>, <span class="hljs-number">164</span>, <span class="hljs-number">47</span>], [<span class="hljs-number">172</span>, <span class="hljs-number">68</span>, <span class="hljs-number">185</span>, <span class="hljs-number">199</span>, <span class="hljs-number">78</span>, <span class="hljs-number">133</span>, <span class="hljs-number">50</span>, <span class="hljs-number">94</span>, <span class="hljs-number">160</span>, <span class="hljs-number">100</span>, <span class="hljs-number">202</span>, <span class="hljs-number">18</span>, <span class="hljs-number">229</span>, <span class="hljs-number">129</span>, <span class="hljs-number">25</span>, <span class="hljs-number">66</span>], [<span class="hljs-number">47</span>, <span class="hljs-number">244</span>, <span class="hljs-number">225</span>, <span class="hljs-number">149</span>, <span class="hljs-number">106</span>, <span class="hljs-number">126</span>, <span class="hljs-number">78</span>, <span class="hljs-number">84</span>, <span class="hljs-number">193</span>, <span class="hljs-number">24</span>, <span class="hljs-number">183</span>, <span class="hljs-number">136</span>, <span class="hljs-number">99</span>, <span class="hljs-number">64</span>, <span class="hljs-number">169</span>, <span class="hljs-number">217</span>], [<span class="hljs-number">147</span>, <span class="hljs-number">33</span>, <span class="hljs-number">234</span>, <span class="hljs-number">101</span>, <span class="hljs-number">134</span>, <span class="hljs-number">29</span>, <span class="hljs-number">210</span>, <span class="hljs-number">217</span>, <span class="hljs-number">39</span>, <span class="hljs-number">246</span>, <span class="hljs-number">162</span>, <span class="hljs-number">212</span>, <span class="hljs-number">40</span>, <span class="hljs-number">37</span>, <span class="hljs-number">137</span>, <span class="hljs-number">101</span>], [<span class="hljs-number">140</span>, <span class="hljs-number">214</span>, <span class="hljs-number">38</span>, <span class="hljs-number">115</span>, <span class="hljs-number">32</span>, <span class="hljs-number">247</span>, <span class="hljs-number">125</span>, <span class="hljs-number">99</span>, <span class="hljs-number">240</span>, <span class="hljs-number">126</span>, <span class="hljs-number">12</span>, <span class="hljs-number">46</span>, <span class="hljs-number">169</span>, <span class="hljs-number">232</span>, <span class="hljs-number">66</span>, <span class="hljs-number">8</span>], [<span class="hljs-number">90</span>, <span class="hljs-number">127</span>, <span class="hljs-number">223</span>, <span class="hljs-number">1</span>, <span class="hljs-number">39</span>, <span class="hljs-number">24</span>, <span class="hljs-number">180</span>, <span class="hljs-number">15</span>, <span class="hljs-number">100</span>, <span class="hljs-number">114</span>, <span class="hljs-number">62</span>, <span class="hljs-number">89</span>, <span class="hljs-number">157</span>, <span class="hljs-number">68</span>, <span class="hljs-number">159</span>, <span class="hljs-number">174</span>], [<span class="hljs-number">214</span>, <span class="hljs-number">213</span>, <span class="hljs-number">243</span>, <span class="hljs-number">113</span>, <span class="hljs-number">121</span>, <span class="hljs-number">48</span>, <span class="hljs-number">29</span>, <span class="hljs-number">54</span>, <span class="hljs-number">90</span>, <span class="hljs-number">236</span>, <span class="hljs-number">32</span>, <span class="hljs-number">74</span>, <span class="hljs-number">247</span>, <span class="hljs-number">87</span>, <span class="hljs-number">37</span>, <span class="hljs-number">97</span>], [<span class="hljs-number">121</span>, <span class="hljs-number">189</span>, <span class="hljs-number">117</span>, <span class="hljs-number">202</span>, <span class="hljs-number">32</span>, <span class="hljs-number">77</span>, <span class="hljs-number">41</span>, <span class="hljs-number">36</span>, <span class="hljs-number">117</span>, <span class="hljs-number">23</span>, <span class="hljs-number">46</span>, <span class="hljs-number">76</span>, <span class="hljs-number">194</span>, <span class="hljs-number">141</span>, <span class="hljs-number">7</span>, <span class="hljs-number">138</span>], [<span class="hljs-number">183</span>, <span class="hljs-number">241</span>, <span class="hljs-number">176</span>, <span class="hljs-number">248</span>, <span class="hljs-number">149</span>, <span class="hljs-number">56</span>, <span class="hljs-number">163</span>, <span class="hljs-number">17</span>, <span class="hljs-number">181</span>, <span class="hljs-number">40</span>, <span class="hljs-number">115</span>, <span class="hljs-number">246</span>, <span class="hljs-number">95</span>, <span class="hljs-number">70</span>, <span class="hljs-number">128</span>, <span class="hljs-number">164</span>], [<span class="hljs-number">120</span>, <span class="hljs-number">49</span>, <span class="hljs-number">189</span>, <span class="hljs-number">204</span>, <span class="hljs-number">152</span>, <span class="hljs-number">29</span>, <span class="hljs-number">229</span>, <span class="hljs-number">172</span>, <span class="hljs-number">155</span>, <span class="hljs-number">140</span>, <span class="hljs-number">127</span>, <span class="hljs-number">3</span>, <span class="hljs-number">110</span>, <span class="hljs-number">34</span>, <span class="hljs-number">48</span>, <span class="hljs-number">49</span>], [<span class="hljs-number">101</span>, <span class="hljs-number">156</span>, <span class="hljs-number">234</span>, <span class="hljs-number">128</span>, <span class="hljs-number">219</span>, <span class="hljs-number">201</span>, <span class="hljs-number">225</span>, <span class="hljs-number">43</span>, <span class="hljs-number">22</span>, <span class="hljs-number">217</span>, <span class="hljs-number">247</span>, <span class="hljs-number">187</span>, <span class="hljs-number">13</span>, <span class="hljs-number">96</span>, <span class="hljs-number">124</span>, <span class="hljs-number">6</span>], [<span class="hljs-number">129</span>, <span class="hljs-number">105</span>, <span class="hljs-number">45</span>, <span class="hljs-number">14</span>, <span class="hljs-number">168</span>, <span class="hljs-number">214</span>, <span class="hljs-number">33</span>, <span class="hljs-number">183</span>, <span class="hljs-number">37</span>, <span class="hljs-number">243</span>, <span class="hljs-number">11</span>, <span class="hljs-number">3</span>, <span class="hljs-number">194</span>, <span class="hljs-number">17</span>, <span class="hljs-number">53</span>, <span class="hljs-number">74</span>], [<span class="hljs-number">210</span>, <span class="hljs-number">9</span>, <span class="hljs-number">16</span>, <span class="hljs-number">165</span>, <span class="hljs-number">90</span>, <span class="hljs-number">142</span>, <span class="hljs-number">189</span>, <span class="hljs-number">82</span>, <span class="hljs-number">39</span>, <span class="hljs-number">159</span>, <span class="hljs-number">183</span>, <span class="hljs-number">164</span>, <span class="hljs-number">82</span>, <span class="hljs-number">235</span>, <span class="hljs-number">239</span>, <span class="hljs-number">141</span>]])<br><br>b = Matrix(G,[[<span class="hljs-number">208</span>], [<span class="hljs-number">185</span>], [<span class="hljs-number">45</span>], [<span class="hljs-number">175</span>], [<span class="hljs-number">138</span>], [<span class="hljs-number">113</span>], [<span class="hljs-number">217</span>], [<span class="hljs-number">206</span>], [<span class="hljs-number">205</span>], [<span class="hljs-number">15</span>], [<span class="hljs-number">184</span>], [<span class="hljs-number">135</span>], [<span class="hljs-number">43</span>], [<span class="hljs-number">95</span>], [<span class="hljs-number">234</span>], [<span class="hljs-number">170</span>]])<br><br>c1 = Matrix(G,[[<span class="hljs-number">127</span>, <span class="hljs-number">90</span>, <span class="hljs-number">38</span>, <span class="hljs-number">137</span>, <span class="hljs-number">249</span>, <span class="hljs-number">34</span>, <span class="hljs-number">205</span>, <span class="hljs-number">116</span>, <span class="hljs-number">219</span>, <span class="hljs-number">131</span>, <span class="hljs-number">139</span>, <span class="hljs-number">237</span>, <span class="hljs-number">223</span>, <span class="hljs-number">202</span>, <span class="hljs-number">184</span>, <span class="hljs-number">163</span>], [<span class="hljs-number">29</span>, <span class="hljs-number">44</span>, <span class="hljs-number">107</span>, <span class="hljs-number">78</span>, <span class="hljs-number">248</span>, <span class="hljs-number">79</span>, <span class="hljs-number">139</span>, <span class="hljs-number">122</span>, <span class="hljs-number">127</span>, <span class="hljs-number">165</span>, <span class="hljs-number">188</span>, <span class="hljs-number">113</span>, <span class="hljs-number">43</span>, <span class="hljs-number">72</span>, <span class="hljs-number">198</span>, <span class="hljs-number">105</span>], [<span class="hljs-number">99</span>, <span class="hljs-number">88</span>, <span class="hljs-number">7</span>, <span class="hljs-number">129</span>, <span class="hljs-number">237</span>, <span class="hljs-number">55</span>, <span class="hljs-number">239</span>, <span class="hljs-number">157</span>, <span class="hljs-number">37</span>, <span class="hljs-number">189</span>, <span class="hljs-number">188</span>, <span class="hljs-number">207</span>, <span class="hljs-number">228</span>, <span class="hljs-number">166</span>, <span class="hljs-number">80</span>, <span class="hljs-number">83</span>], [<span class="hljs-number">25</span>, <span class="hljs-number">223</span>, <span class="hljs-number">56</span>, <span class="hljs-number">35</span>, <span class="hljs-number">62</span>, <span class="hljs-number">3</span>, <span class="hljs-number">99</span>, <span class="hljs-number">239</span>, <span class="hljs-number">96</span>, <span class="hljs-number">15</span>, <span class="hljs-number">239</span>, <span class="hljs-number">132</span>, <span class="hljs-number">16</span>, <span class="hljs-number">234</span>, <span class="hljs-number">168</span>, <span class="hljs-number">143</span>], [<span class="hljs-number">71</span>, <span class="hljs-number">44</span>, <span class="hljs-number">104</span>, <span class="hljs-number">130</span>, <span class="hljs-number">240</span>, <span class="hljs-number">90</span>, <span class="hljs-number">94</span>, <span class="hljs-number">136</span>, <span class="hljs-number">59</span>, <span class="hljs-number">4</span>, <span class="hljs-number">170</span>, <span class="hljs-number">102</span>, <span class="hljs-number">100</span>, <span class="hljs-number">70</span>, <span class="hljs-number">206</span>, <span class="hljs-number">11</span>], [<span class="hljs-number">5</span>, <span class="hljs-number">58</span>, <span class="hljs-number">220</span>, <span class="hljs-number">136</span>, <span class="hljs-number">151</span>, <span class="hljs-number">101</span>, <span class="hljs-number">183</span>, <span class="hljs-number">245</span>, <span class="hljs-number">35</span>, <span class="hljs-number">197</span>, <span class="hljs-number">143</span>, <span class="hljs-number">177</span>, <span class="hljs-number">93</span>, <span class="hljs-number">177</span>, <span class="hljs-number">4</span>, <span class="hljs-number">29</span>], [<span class="hljs-number">246</span>, <span class="hljs-number">12</span>, <span class="hljs-number">215</span>, <span class="hljs-number">117</span>, <span class="hljs-number">173</span>, <span class="hljs-number">222</span>, <span class="hljs-number">55</span>, <span class="hljs-number">117</span>, <span class="hljs-number">183</span>, <span class="hljs-number">187</span>, <span class="hljs-number">124</span>, <span class="hljs-number">40</span>, <span class="hljs-number">69</span>, <span class="hljs-number">192</span>, <span class="hljs-number">220</span>, <span class="hljs-number">185</span>], [<span class="hljs-number">197</span>, <span class="hljs-number">144</span>, <span class="hljs-number">242</span>, <span class="hljs-number">97</span>, <span class="hljs-number">182</span>, <span class="hljs-number">59</span>, <span class="hljs-number">129</span>, <span class="hljs-number">64</span>, <span class="hljs-number">86</span>, <span class="hljs-number">52</span>, <span class="hljs-number">79</span>, <span class="hljs-number">163</span>, <span class="hljs-number">44</span>, <span class="hljs-number">159</span>, <span class="hljs-number">61</span>, <span class="hljs-number">83</span>], [<span class="hljs-number">170</span>, <span class="hljs-number">202</span>, <span class="hljs-number">30</span>, <span class="hljs-number">234</span>, <span class="hljs-number">196</span>, <span class="hljs-number">193</span>, <span class="hljs-number">205</span>, <span class="hljs-number">198</span>, <span class="hljs-number">245</span>, <span class="hljs-number">49</span>, <span class="hljs-number">135</span>, <span class="hljs-number">93</span>, <span class="hljs-number">46</span>, <span class="hljs-number">45</span>, <span class="hljs-number">12</span>, <span class="hljs-number">162</span>], [<span class="hljs-number">228</span>, <span class="hljs-number">156</span>, <span class="hljs-number">36</span>, <span class="hljs-number">84</span>, <span class="hljs-number">79</span>, <span class="hljs-number">184</span>, <span class="hljs-number">1</span>, <span class="hljs-number">50</span>, <span class="hljs-number">197</span>, <span class="hljs-number">137</span>, <span class="hljs-number">171</span>, <span class="hljs-number">116</span>, <span class="hljs-number">131</span>, <span class="hljs-number">64</span>, <span class="hljs-number">136</span>, <span class="hljs-number">49</span>], [<span class="hljs-number">63</span>, <span class="hljs-number">182</span>, <span class="hljs-number">170</span>, <span class="hljs-number">164</span>, <span class="hljs-number">100</span>, <span class="hljs-number">80</span>, <span class="hljs-number">116</span>, <span class="hljs-number">95</span>, <span class="hljs-number">140</span>, <span class="hljs-number">55</span>, <span class="hljs-number">187</span>, <span class="hljs-number">43</span>, <span class="hljs-number">152</span>, <span class="hljs-number">141</span>, <span class="hljs-number">12</span>, <span class="hljs-number">232</span>], [<span class="hljs-number">17</span>, <span class="hljs-number">92</span>, <span class="hljs-number">142</span>, <span class="hljs-number">86</span>, <span class="hljs-number">35</span>, <span class="hljs-number">222</span>, <span class="hljs-number">59</span>, <span class="hljs-number">177</span>, <span class="hljs-number">76</span>, <span class="hljs-number">64</span>, <span class="hljs-number">206</span>, <span class="hljs-number">173</span>, <span class="hljs-number">160</span>, <span class="hljs-number">125</span>, <span class="hljs-number">182</span>, <span class="hljs-number">112</span>], [<span class="hljs-number">247</span>, <span class="hljs-number">144</span>, <span class="hljs-number">243</span>, <span class="hljs-number">147</span>, <span class="hljs-number">145</span>, <span class="hljs-number">100</span>, <span class="hljs-number">11</span>, <span class="hljs-number">121</span>, <span class="hljs-number">188</span>, <span class="hljs-number">243</span>, <span class="hljs-number">25</span>, <span class="hljs-number">236</span>, <span class="hljs-number">74</span>, <span class="hljs-number">236</span>, <span class="hljs-number">148</span>, <span class="hljs-number">66</span>], [<span class="hljs-number">218</span>, <span class="hljs-number">123</span>, <span class="hljs-number">213</span>, <span class="hljs-number">237</span>, <span class="hljs-number">194</span>, <span class="hljs-number">202</span>, <span class="hljs-number">13</span>, <span class="hljs-number">31</span>, <span class="hljs-number">66</span>, <span class="hljs-number">241</span>, <span class="hljs-number">144</span>, <span class="hljs-number">86</span>, <span class="hljs-number">155</span>, <span class="hljs-number">74</span>, <span class="hljs-number">174</span>, <span class="hljs-number">112</span>], [<span class="hljs-number">19</span>, <span class="hljs-number">7</span>, <span class="hljs-number">55</span>, <span class="hljs-number">106</span>, <span class="hljs-number">53</span>, <span class="hljs-number">49</span>, <span class="hljs-number">35</span>, <span class="hljs-number">106</span>, <span class="hljs-number">201</span>, <span class="hljs-number">220</span>, <span class="hljs-number">89</span>, <span class="hljs-number">235</span>, <span class="hljs-number">148</span>, <span class="hljs-number">72</span>, <span class="hljs-number">170</span>, <span class="hljs-number">88</span>], [<span class="hljs-number">186</span>, <span class="hljs-number">76</span>, <span class="hljs-number">86</span>, <span class="hljs-number">89</span>, <span class="hljs-number">54</span>, <span class="hljs-number">203</span>, <span class="hljs-number">186</span>, <span class="hljs-number">142</span>, <span class="hljs-number">8</span>, <span class="hljs-number">86</span>, <span class="hljs-number">174</span>, <span class="hljs-number">115</span>, <span class="hljs-number">133</span>, <span class="hljs-number">227</span>, <span class="hljs-number">104</span>, <span class="hljs-number">107</span>]])<br><br>c2 = Matrix(G,[[<span class="hljs-number">235</span>], [<span class="hljs-number">9</span>], [<span class="hljs-number">224</span>], [<span class="hljs-number">158</span>], [<span class="hljs-number">103</span>], [<span class="hljs-number">151</span>], [<span class="hljs-number">7</span>], [<span class="hljs-number">124</span>], [<span class="hljs-number">159</span>], [<span class="hljs-number">100</span>], [<span class="hljs-number">23</span>], [<span class="hljs-number">199</span>], [<span class="hljs-number">206</span>], [<span class="hljs-number">125</span>], [<span class="hljs-number">235</span>], [<span class="hljs-number">10</span>]])<br><br><span class="hljs-comment"># from sage.all import *</span><br><span class="hljs-comment"># const = 2**8</span><br><span class="hljs-comment"># M1 = block_matrix([[A.T],[b.T],[identity_matrix(16)*q]]) * const</span><br><span class="hljs-comment"># M2 = Matrix(17+16, 17)</span><br><span class="hljs-comment"># for _ in range(16):</span><br><span class="hljs-comment">#     M2[_,_] = 1</span><br><span class="hljs-comment"># M2[16,16] = const</span><br><span class="hljs-comment"># M = block_matrix([M1,M2],ncols=2)</span><br><span class="hljs-comment"># ML = M.LLL()</span><br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">decrypt</span>(<span class="hljs-params">c1, c2, s</span>):<br>    m_dec = (c2 - c1 * s).T<br>    m_rec = [<span class="hljs-built_in">round</span>(<span class="hljs-number">2</span> * <span class="hljs-built_in">int</span>(_) / q) % <span class="hljs-number">2</span> <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> m_dec[<span class="hljs-number">0</span>]]<br>    m_bin = <span class="hljs-string">&#x27;&#x27;</span>.join([<span class="hljs-built_in">str</span>(bit) <span class="hljs-keyword">for</span> bit <span class="hljs-keyword">in</span> m_rec])  <span class="hljs-comment"># 将SymPy矩阵转换为二进制字符串</span><br>    m_rec_int = <span class="hljs-built_in">int</span>(m_bin, <span class="hljs-number">2</span>)  <span class="hljs-comment"># 将二进制字符串转换为整数</span><br>    <span class="hljs-keyword">return</span> m_rec_int<br><br><span class="hljs-keyword">from</span> tqdm <span class="hljs-keyword">import</span> trange<br><span class="hljs-keyword">from</span> Crypto.Util.number <span class="hljs-keyword">import</span> long_to_bytes<br>G = GF(q)<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> trange(<span class="hljs-number">2</span>**<span class="hljs-number">16</span>):<br>    e = Matrix(G,[<span class="hljs-built_in">int</span>(_) <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">bin</span>(i)[<span class="hljs-number">2</span>:].rjust(<span class="hljs-number">16</span>,<span class="hljs-string">&#x27;0&#x27;</span>)]).T<br>    s = A.solve_right(b - e)<br>    msg = decrypt(c1,c2,s)<br>    <span class="hljs-keyword">if</span> msg.bit_length() &lt;= <span class="hljs-number">16</span>:<br>        <span class="hljs-built_in">print</span>(msg)<br>    <span class="hljs-comment"># flag = long_to_bytes(msg)</span><br>    <span class="hljs-comment"># if b&#x27;flag&#x27; in flag:</span><br>    <span class="hljs-comment">#     print(flag)</span><br></code></pre></td></tr></table></figure>

<p>也许密码应该优先考虑爆破？有点难绷了。</p>
<h4 id="flag1"><a href="#flag1" class="headerlink" title="flag1"></a>flag1</h4><p>这题其实和当时2023熵密杯的第二题非常相似，但是当时直接逆回来写就出了，这一次我们死活没出，最后是爆破2**32出的，后来上的hint也提示说应该多线程爆破，最后三台电脑一起跑，大概两三分钟就出了。</p>
<p>题目莫得了，只有exp。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#include &lt;stdio.h&gt;</span><br><span class="hljs-comment">#include &lt;string.h&gt;</span><br><span class="hljs-comment">#include &lt;unistd.h&gt;</span><br><span class="hljs-comment">#include &lt;stdlib.h&gt;</span><br><span class="hljs-comment">#include &lt;sys/wait.h&gt;</span><br><span class="hljs-comment">#include &lt;openssl/sha.h&gt;</span><br><br><span class="hljs-comment">#define ROUND 16</span><br><br>// S-Box 16x16<br>unsigned char rev_sBox[] = &#123;<span class="hljs-number">13</span>, <span class="hljs-number">4</span>, <span class="hljs-number">0</span>, <span class="hljs-number">5</span>,<br>                            <span class="hljs-number">2</span>, <span class="hljs-number">12</span>, <span class="hljs-number">11</span>, <span class="hljs-number">8</span>,<br>                            <span class="hljs-number">10</span>, <span class="hljs-number">6</span>, <span class="hljs-number">1</span>, <span class="hljs-number">9</span>,<br>                            <span class="hljs-number">3</span>, <span class="hljs-number">15</span>, <span class="hljs-number">7</span>, <span class="hljs-number">14</span>&#125;;<br><br>// 将十六进制字符串转换为 unsigned char 数组<br>void hex_to_bytes(const char *hex_str, unsigned char *<span class="hljs-built_in">bytes</span>, size_t bytes_len)<br>&#123;<br>    size_t hex_len = strlen(hex_str);<br>    <span class="hljs-keyword">if</span> (hex_len % <span class="hljs-number">2</span> != <span class="hljs-number">0</span> || hex_len / <span class="hljs-number">2</span> &gt; bytes_len)<br>    &#123;<br>        fprintf(stderr, <span class="hljs-string">&quot;Invalid hex string length.\n&quot;</span>);<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">for</span> (size_t i = <span class="hljs-number">0</span>; i &lt; hex_len / <span class="hljs-number">2</span>; i++)<br>    &#123;<br>        sscanf(hex_str + <span class="hljs-number">2</span> * i, <span class="hljs-string">&quot;%2hhx&quot;</span>, &amp;<span class="hljs-built_in">bytes</span>[i]);<br>    &#125;<br>&#125;<br><br>// 派生轮密钥<br>void derive_round_key(unsigned <span class="hljs-built_in">int</span> key, unsigned char *round_key, <span class="hljs-built_in">int</span> length)<br>&#123;<br><br>    unsigned <span class="hljs-built_in">int</span> tmp = key;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; length / <span class="hljs-number">16</span>; i++)<br>    &#123;<br>        memcpy(round_key + i * <span class="hljs-number">16</span>, &amp;tmp, <span class="hljs-number">4</span>);<br>        tmp++;<br>        memcpy(round_key + i * <span class="hljs-number">16</span> + <span class="hljs-number">4</span>, &amp;tmp, <span class="hljs-number">4</span>);<br>        tmp++;<br>        memcpy(round_key + i * <span class="hljs-number">16</span> + <span class="hljs-number">8</span>, &amp;tmp, <span class="hljs-number">4</span>);<br>        tmp++;<br>        memcpy(round_key + i * <span class="hljs-number">16</span> + <span class="hljs-number">12</span>, &amp;tmp, <span class="hljs-number">4</span>);<br>        tmp++;<br>    &#125;<br>&#125;<br><br>// 比特逆序<br>void reverseBits(unsigned char *state)<br>&#123;<br>    unsigned char temp[<span class="hljs-number">16</span>];<br>    <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">16</span>; i++)<br>    &#123;<br>        unsigned char byte = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> j = <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">8</span>; j++)<br>        &#123;<br>            byte |= ((state[i] &gt;&gt; j) &amp; <span class="hljs-number">1</span>) &lt;&lt; (<span class="hljs-number">7</span> - j);<br>        &#125;<br>        temp[<span class="hljs-number">15</span> - i] = byte;<br>    &#125;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">16</span>; i++)<br>    &#123;<br>        state[i] = temp[i];<br>    &#125;<br>&#125;<br><br>void rev_leftShiftBytes(unsigned char *state)<br>&#123;<br>    unsigned char temp[<span class="hljs-number">4</span>];<br>    <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">16</span>; i += <span class="hljs-number">4</span>)<br>    &#123;<br>        temp[<span class="hljs-number">0</span>] = ((state[i + <span class="hljs-number">2</span>] &amp; <span class="hljs-number">0x7</span>) &lt;&lt; <span class="hljs-number">5</span>) | (state[i + <span class="hljs-number">3</span>] &gt;&gt; <span class="hljs-number">3</span>);<br>        temp[<span class="hljs-number">1</span>] = ((state[i + <span class="hljs-number">3</span>] &amp; <span class="hljs-number">0x7</span>) &lt;&lt; <span class="hljs-number">5</span>) | (state[i + <span class="hljs-number">0</span>] &gt;&gt; <span class="hljs-number">3</span>);<br>        temp[<span class="hljs-number">2</span>] = ((state[i + <span class="hljs-number">0</span>] &amp; <span class="hljs-number">0x7</span>) &lt;&lt; <span class="hljs-number">5</span>) | (state[i + <span class="hljs-number">1</span>] &gt;&gt; <span class="hljs-number">3</span>);<br>        temp[<span class="hljs-number">3</span>] = ((state[i + <span class="hljs-number">1</span>] &amp; <span class="hljs-number">0x7</span>) &lt;&lt; <span class="hljs-number">5</span>) | (state[i + <span class="hljs-number">2</span>] &gt;&gt; <span class="hljs-number">3</span>);<br>        memcpy(state + i, temp, sizeof temp);<br>    &#125;<br>&#125;<br><br>void rev_sBoxTransform(unsigned char *state)<br>&#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">16</span>; i++)<br>    &#123;<br>        unsigned char lo = rev_sBox[state[i] &amp; <span class="hljs-number">0xF</span>];<br>        unsigned char hi = rev_sBox[state[i] &gt;&gt; <span class="hljs-number">4</span>];<br>        state[i] = (hi &lt;&lt; <span class="hljs-number">4</span>) | lo;<br>    &#125;<br>&#125;<br><br>void addRoundKey(unsigned char *state, unsigned char *roundKey, unsigned <span class="hljs-built_in">int</span> <span class="hljs-built_in">round</span>)<br>&#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">16</span>; i++)<br>    &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> j = <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">8</span>; j++)<br>        &#123;<br>            state[i] ^= ((roundKey[i + <span class="hljs-built_in">round</span> * <span class="hljs-number">16</span>] &gt;&gt; j) &amp; <span class="hljs-number">1</span>) &lt;&lt; j;<br>        &#125;<br>    &#125;<br>&#125;<br><br>void decrypt(const unsigned char *ciphertext, unsigned <span class="hljs-built_in">int</span> key, unsigned char *cleartext)<br>&#123;<br>    unsigned char roundKeys[<span class="hljs-number">16</span> * ROUND] = &#123;&#125;;<br><br>    derive_round_key(key, roundKeys, <span class="hljs-number">16</span> * ROUND);<br><br>    unsigned char state[<span class="hljs-number">16</span>];<br>    memcpy(state, ciphertext, sizeof state);<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> <span class="hljs-built_in">round</span> = ROUND - <span class="hljs-number">1</span>; <span class="hljs-built_in">round</span> &gt;= <span class="hljs-number">0</span>; <span class="hljs-built_in">round</span>--)<br>    &#123;<br>        addRoundKey(state, roundKeys, <span class="hljs-built_in">round</span>);<br>        rev_leftShiftBytes(state);<br>        rev_sBoxTransform(state);<br>        reverseBits(state);<br>    &#125;<br><br>    memcpy(cleartext, state, sizeof state);<br>&#125;<br><br><span class="hljs-built_in">int</span> main(<span class="hljs-built_in">int</span> argc, char **argv)<br>&#123;<br>    unsigned char ciphertext[<span class="hljs-number">16</span>];<br>    hex_to_bytes(<span class="hljs-string">&quot;99F2980AAB4BE8640D8F322147CBA409&quot;</span>, ciphertext, sizeof ciphertext);<br><br>    unsigned char cleartext[<span class="hljs-number">17</span>] = &#123;<span class="hljs-number">0</span>&#125;;<br>    <span class="hljs-keyword">for</span> (unsigned <span class="hljs-built_in">int</span> key = <span class="hljs-number">0x80000000</span>; key &lt;= <span class="hljs-number">0xFFFFFFFF</span>; key++)<br>    &#123;<br>        <span class="hljs-keyword">if</span> (key % <span class="hljs-number">0xFFFFFF</span> == <span class="hljs-number">0</span>)<br>        &#123;<br>            printf(<span class="hljs-string">&quot;key %08X reached\n&quot;</span>, key);<br>        &#125;<br>        decrypt(ciphertext, key, cleartext);<br>        <span class="hljs-keyword">if</span> (strncmp(cleartext, <span class="hljs-string">&quot;pwd:&quot;</span>, <span class="hljs-number">4</span>) == <span class="hljs-number">0</span>)<br>        &#123;<br>            printf(<span class="hljs-string">&quot;valid cleartext found! key=%08X ct=%s&quot;</span>, key, cleartext);<br>            // <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>当时不知道是不是0ops，没拿flag1就拿到flag2了，有点难绷，经典复刻了。</p>
<p>然后爆破就可以拿到压缩包密码，压缩包里面有第一个flag</p>
<p><img src="/../pic/image-20240905144307852.png" srcset="/img/loading.gif" lazyload alt="image-20240905144307852"></p>
<h4 id="flag2"><a href="#flag2" class="headerlink" title="flag2"></a>flag2</h4><p>第二个flag还挺有意思。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;openssl/ec.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;openssl/rand.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SM2LEN 32</span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">error</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Error.\n&quot;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">error_partial_verify</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Error partial verify.\n&quot;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">print_flag2</span><span class="hljs-params">(<span class="hljs-type">const</span> BIGNUM *d2)</span> &#123;<br>    <span class="hljs-type">char</span> *hex_str = BN_bn2hex(d2);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; hex_str[i] != <span class="hljs-string">&#x27;\0&#x27;</span>; i++) &#123;<br>        <span class="hljs-keyword">if</span> (hex_str[i] &gt;= <span class="hljs-string">&#x27;A&#x27;</span> &amp;&amp; hex_str[i] &lt;= <span class="hljs-string">&#x27;F&#x27;</span>) &#123;<br>            hex_str[i] += <span class="hljs-number">32</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;flag2&#123;%s&#125;\n&quot;</span>, hex_str);<br>&#125;<br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>    <span class="hljs-type">char</span> s2[SM2LEN * <span class="hljs-number">2</span> + <span class="hljs-number">1</span>];<br>    <span class="hljs-type">char</span> s3[SM2LEN * <span class="hljs-number">2</span> + <span class="hljs-number">1</span>];<br>    <span class="hljs-type">char</span> r[SM2LEN * <span class="hljs-number">2</span> + <span class="hljs-number">1</span>];<br>    <span class="hljs-type">int</span> success;<br>&#125; Result;<br><br><span class="hljs-comment">// 协同签名服务端签名算法</span><br>Result <span class="hljs-title function_">server</span><span class="hljs-params">(<span class="hljs-type">char</span>* str_e,<span class="hljs-type">char</span>* str_p1x,<span class="hljs-type">char</span>* str_p1y,<span class="hljs-type">char</span>* str_q1x,<span class="hljs-type">char</span>* str_q1y,<span class="hljs-type">char</span>* str_r1,<span class="hljs-type">char</span>* str_s1)</span>&#123;<br>    Result res = &#123;<span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-number">0</span>&#125;;<br><br>	<span class="hljs-type">int</span> rv = <span class="hljs-number">1</span>;<br>	BIGNUM *e,*a,*b,*p,*n,*x,*y;<br>	BIGNUM *d2,*r1,*s1,*p1x,*p1y,*q1x,*q1y;<br>	BIGNUM *u1,*u2,*xprime,*yprime,*k2,*k3,*x1,*y1,*r,*s2,*s3,*s,*tmp1,*tmp2,*tmp3;<br>	EC_GROUP* group;<br>	EC_POINT *generator,*G,*P,*P1,*Q1,*TMP;<br><br>	BN_CTX* bn_ctx = BN_CTX_new();<br>	BN_CTX_start(bn_ctx);<br>	<span class="hljs-keyword">if</span> (!bn_ctx)<br>		&#123; error(); <span class="hljs-keyword">return</span> res; &#125;<br>	e = BN_CTX_get(bn_ctx);<br>	a = BN_CTX_get(bn_ctx);<br>	b = BN_CTX_get(bn_ctx);<br>	p = BN_CTX_get(bn_ctx);<br>	n = BN_CTX_get(bn_ctx);<br>	d2 = BN_CTX_get(bn_ctx);<br>	x = BN_CTX_get(bn_ctx);<br>	y = BN_CTX_get(bn_ctx);<br>	p1x = BN_CTX_get(bn_ctx);<br>	p1y = BN_CTX_get(bn_ctx);<br>	q1x = BN_CTX_get(bn_ctx);<br>	q1y = BN_CTX_get(bn_ctx);<br>	r1 = BN_CTX_get(bn_ctx);<br>	s1 = BN_CTX_get(bn_ctx);<br>	u1 = BN_CTX_get(bn_ctx);<br>	u2 = BN_CTX_get(bn_ctx);<br>	xprime = BN_CTX_get(bn_ctx);<br>	yprime = BN_CTX_get(bn_ctx);<br>	k2 = BN_CTX_get(bn_ctx);<br>	k3 = BN_CTX_get(bn_ctx);<br>	x1 = BN_CTX_get(bn_ctx);<br>	y1 = BN_CTX_get(bn_ctx);<br>	r = BN_CTX_get(bn_ctx);<br>	s2 = BN_CTX_get(bn_ctx);<br>	s3 = BN_CTX_get(bn_ctx);<br>	s = BN_CTX_get(bn_ctx);<br>	tmp1 = BN_CTX_get(bn_ctx);<br>	tmp2 = BN_CTX_get(bn_ctx);<br>	tmp3 = BN_CTX_get(bn_ctx);<br><br>	<span class="hljs-keyword">if</span> (<br>		!BN_hex2bn(&amp;e, str_e) ||<br>		!BN_hex2bn(&amp;p1x, str_p1x) ||<br>		!BN_hex2bn(&amp;p1y, str_p1y) ||<br>		!BN_hex2bn(&amp;q1x, str_q1x) ||<br>		!BN_hex2bn(&amp;q1y, str_q1y) ||<br>		!BN_hex2bn(&amp;r1, str_r1) ||<br>		!BN_hex2bn(&amp;s1, str_s1) ||<br>		!BN_hex2bn(&amp;a, <span class="hljs-string">&quot;FFFFFFFEFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF00000000FFFFFFFFFFFFFFFC&quot;</span>) ||<br>		!BN_hex2bn(&amp;b, <span class="hljs-string">&quot;28E9FA9E9D9F5E344D5A9E4BCF6509A7F39789F515AB8F92DDBCBD414D940E93&quot;</span>) ||<br>		!BN_hex2bn(&amp;p, <span class="hljs-string">&quot;FFFFFFFEFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF00000000FFFFFFFFFFFFFFFF&quot;</span>) ||<br>		!BN_hex2bn(&amp;n, <span class="hljs-string">&quot;FFFFFFFEFFFFFFFFFFFFFFFFFFFFFFFF7203DF6B21C6052B53BBF40939D54123&quot;</span>) ||<br>		<span class="hljs-comment">// d2 = ds (server key)</span><br>		!BN_hex2bn(&amp;d2, <span class="hljs-string">&quot;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX&quot;</span>) ||<br>		!BN_hex2bn(&amp;x, <span class="hljs-string">&quot;32C4AE2C1F1981195F9904466A39C9948FE30BBFF2660BE1715A4589334C74C7&quot;</span>) ||<br>		!BN_hex2bn(&amp;y, <span class="hljs-string">&quot;BC3736A2F4F6779C59BDCEE36B692153D0A9877CC62A474002DF32E52139F0A0&quot;</span>) ||<br>		!BN_rand_range(k2,n) ||<br>		!BN_copy(k3, k2)<br>		)<br>		&#123; error(); <span class="hljs-keyword">return</span> res; &#125;<br><br>    <span class="hljs-comment">// generate k2 in [1, n-1]</span><br>	<span class="hljs-keyword">while</span>(BN_is_zero(k2))&#123;<br>        <span class="hljs-keyword">if</span> (<br>            !BN_rand_range(k2,n) ||<br>            !BN_copy(k3, k2)<br>            )<br>            &#123; error(); <span class="hljs-keyword">return</span> res; &#125;<br>	&#125;<br><br>	group = EC_GROUP_new_curve_GFp(p, a, b, bn_ctx);<br>	generator = EC_POINT_new(group);<br>	<span class="hljs-keyword">if</span> (!generator)<br>		&#123; error(); <span class="hljs-keyword">return</span> res; &#125;<br>	<span class="hljs-keyword">if</span> (<span class="hljs-number">1</span> != EC_POINT_set_affine_coordinates_GFp(group, generator, x, y, bn_ctx))<br>		&#123; error(); <span class="hljs-keyword">return</span> res; &#125;<br>	<span class="hljs-keyword">if</span> (<span class="hljs-number">1</span> != EC_GROUP_set_generator(group, generator, n, <span class="hljs-literal">NULL</span>))<br>		&#123; error(); <span class="hljs-keyword">return</span> res; &#125;<br><br>	G = EC_POINT_new(group);<br>	P = EC_POINT_new(group);<br>	P1 = EC_POINT_new(group);<br>	Q1 = EC_POINT_new(group);<br>	TMP = EC_POINT_new(group);<br><br>    <span class="hljs-comment">// if r1=0 or s1=0, error</span><br>	<span class="hljs-keyword">if</span> (BN_is_zero(r1) || BN_is_zero(s1))<br>		&#123; error(); <span class="hljs-keyword">return</span> res; &#125;<br><br>	<span class="hljs-comment">// set P1 = (p1x, p1y)</span><br>	<span class="hljs-keyword">if</span> (<span class="hljs-number">1</span> != EC_POINT_set_affine_coordinates_GFp(group, P1, p1x, p1y, bn_ctx))<br>		&#123; error(); <span class="hljs-keyword">return</span> res; &#125;<br><br>	<span class="hljs-comment">// set Q1 = (q1x, q1y)</span><br>	<span class="hljs-keyword">if</span> (<span class="hljs-number">1</span> != EC_POINT_set_affine_coordinates_GFp(group, Q1, q1x, q1y, bn_ctx))<br>		&#123; error(); <span class="hljs-keyword">return</span> res; &#125;<br><br>	<span class="hljs-comment">//u1 = e * (s1^(-1)) mod n, u2 = r1 * (s1^(-1)) mod n</span><br>	<span class="hljs-keyword">if</span> (!BN_mod_inverse(tmp1, s1, n, bn_ctx) ||<br>		!BN_mod_mul(u1, e, tmp1, n, bn_ctx) ||<br>		!BN_mod_mul(u2, r1, tmp1, n, bn_ctx) ||<br>		!BN_mod(u1, u1, n, bn_ctx) ||<br>		!BN_mod(u2, u2, n, bn_ctx)<br>		)<br>		&#123; error(); <span class="hljs-keyword">return</span> res; &#125;<br><br>	<span class="hljs-comment">//u1*G + u2*P1 = (x&#x27;, y&#x27;)</span><br>	<span class="hljs-keyword">if</span> (!EC_POINT_mul(group, TMP, u1, P1, u2, bn_ctx))<br>		&#123; error(); <span class="hljs-keyword">return</span> res; &#125;<br><br>	<span class="hljs-keyword">if</span> (!EC_POINT_get_affine_coordinates_GFp(group, TMP, xprime, yprime, bn_ctx))<br>		&#123; error(); <span class="hljs-keyword">return</span> res; &#125;<br><br>	<span class="hljs-comment">//verify r1 = x&#x27; mod n</span><br>	<span class="hljs-keyword">if</span> (!BN_mod(xprime, xprime, n, bn_ctx))<br>		&#123; error(); <span class="hljs-keyword">return</span> res; &#125;<br><br>	<span class="hljs-keyword">if</span>(BN_cmp(r1,xprime))<br>		&#123; error_partial_verify(); <span class="hljs-keyword">return</span> res; &#125;<br><br>	<span class="hljs-comment">//k2*G + k3*Q1 = (x1, y1)</span><br>	<span class="hljs-keyword">if</span> (!EC_POINT_mul(group, TMP, k2, Q1, k3, bn_ctx))<br>		&#123; error(); <span class="hljs-keyword">return</span> res; &#125;<br><br>	<span class="hljs-keyword">if</span> (!EC_POINT_get_affine_coordinates_GFp(group, TMP, x1, y1, bn_ctx))<br>		&#123; error(); <span class="hljs-keyword">return</span> res; &#125;<br><br>	<span class="hljs-comment">//r=(e+x1) mod n</span><br>	<span class="hljs-keyword">if</span> (!BN_mod_add(r, e, x1, n, bn_ctx))<br>		&#123; error(); <span class="hljs-keyword">return</span> res; &#125;<br><br>	<span class="hljs-keyword">if</span> (BN_is_zero(r))<br>		&#123; error(); <span class="hljs-keyword">return</span> res; &#125;<br>	<span class="hljs-built_in">strncpy</span>(res.r, BN_bn2hex(r), <span class="hljs-number">2</span>*SM2LEN+<span class="hljs-number">1</span>);<br><br>	<span class="hljs-comment">//s2 = d2 * k3 mod n, s3 = d2 * (r+k2) mod n</span><br>	<span class="hljs-keyword">if</span> (!BN_mod_mul(s2, d2, k3, n, bn_ctx) ||<br>		!BN_mod_add(tmp1, r, k2, n, bn_ctx) ||<br>		!BN_mod_mul(s3, d2, tmp1, n, bn_ctx) ||<br>		!BN_mod(s2, s2, n, bn_ctx) ||<br>		!BN_mod(s3, s3, n, bn_ctx)<br>		)<br>		&#123; error(); <span class="hljs-keyword">return</span> res; &#125;<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;s2: %s\n&quot;</span>,BN_bn2hex(s2));<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;s3: %s\n&quot;</span>,BN_bn2hex(s3));<br>	<span class="hljs-built_in">strncpy</span>(res.s2, BN_bn2hex(s2), <span class="hljs-number">2</span>*SM2LEN+<span class="hljs-number">1</span>);<br>	<span class="hljs-built_in">strncpy</span>(res.s3, BN_bn2hex(s3), <span class="hljs-number">2</span>*SM2LEN+<span class="hljs-number">1</span>);<br><br>    <span class="hljs-comment">// flag2 的格式如下：flag2&#123;xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx&#125;，大括号中的内容为 16 进制格式（字母小写）的 d2。</span><br>    print_flag2(d2);<br><br>    rv = <span class="hljs-number">0</span>;<br>    BN_CTX_free(bn_ctx);<br><br>    <span class="hljs-keyword">return</span> rv;<br>&#125;<br><br><span class="hljs-comment">// 计算公钥P</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">getPublicKey</span><span class="hljs-params">(<span class="hljs-type">char</span> *str_d2, <span class="hljs-type">char</span> *str_p1x, <span class="hljs-type">char</span> *str_p1y)</span> &#123;<br>    <span class="hljs-type">int</span> rv = <span class="hljs-number">1</span>;<br>    BIGNUM *negone, *a, *b, *p, *n, *x, *y;<br>    BIGNUM *d2, *p1x, *p1y, *px, *py;<br>    BIGNUM *tmp1, *tmp2;<br>    EC_GROUP *group;<br>    EC_POINT *generator, *G, *P, *P1;<br><br>    BN_CTX *bn_ctx = BN_CTX_new();<br>    BN_CTX_start(bn_ctx);<br>    <span class="hljs-keyword">if</span> (!bn_ctx) &#123;<br>        error();<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>    &#125;<br><br>    negone = BN_CTX_get(bn_ctx);<br>    a = BN_CTX_get(bn_ctx);<br>    b = BN_CTX_get(bn_ctx);<br>    p = BN_CTX_get(bn_ctx);<br>    n = BN_CTX_get(bn_ctx);<br>    d2 = BN_CTX_get(bn_ctx);<br>    x = BN_CTX_get(bn_ctx);<br>    y = BN_CTX_get(bn_ctx);<br>    p1x = BN_CTX_get(bn_ctx);<br>    p1y = BN_CTX_get(bn_ctx);<br>    px = BN_CTX_get(bn_ctx);<br>    py = BN_CTX_get(bn_ctx);<br>    tmp1 = BN_CTX_get(bn_ctx);<br>    tmp2 = BN_CTX_get(bn_ctx);<br><br>    <span class="hljs-keyword">if</span> (<br>        !BN_hex2bn(&amp;d2, str_d2) ||<br>        !BN_hex2bn(&amp;p1x, str_p1x) ||<br>        !BN_hex2bn(&amp;p1y, str_p1y) ||<br>        !BN_hex2bn(&amp;a, <span class="hljs-string">&quot;FFFFFFFEFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF00000000FFFFFFFFFFFFFFFC&quot;</span>) ||<br>        !BN_hex2bn(&amp;b, <span class="hljs-string">&quot;28E9FA9E9D9F5E344D5A9E4BCF6509A7F39789F515AB8F92DDBCBD414D940E93&quot;</span>) ||<br>        !BN_hex2bn(&amp;p, <span class="hljs-string">&quot;FFFFFFFEFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF00000000FFFFFFFFFFFFFFFF&quot;</span>) ||<br>        !BN_hex2bn(&amp;n, <span class="hljs-string">&quot;FFFFFFFEFFFFFFFFFFFFFFFFFFFFFFFF7203DF6B21C6052B53BBF40939D54123&quot;</span>) ||<br>        !BN_hex2bn(&amp;x, <span class="hljs-string">&quot;32C4AE2C1F1981195F9904466A39C9948FE30BBFF2660BE1715A4589334C74C7&quot;</span>) ||<br>        !BN_hex2bn(&amp;y, <span class="hljs-string">&quot;BC3736A2F4F6779C59BDCEE36B692153D0A9877CC62A474002DF32E52139F0A0&quot;</span>)<br>    ) &#123;<br>        error();<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>    &#125;<br>    group = EC_GROUP_new_curve_GFp(p, a, b, bn_ctx);<br>    generator = EC_POINT_new(group);<br>    <span class="hljs-keyword">if</span> (!generator) &#123;<br>        error();<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-number">1</span> != EC_POINT_set_affine_coordinates_GFp(group, generator, x, y, bn_ctx)) &#123;<br>        error();<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-number">1</span> != EC_GROUP_set_generator(group, generator, n, <span class="hljs-literal">NULL</span>)) &#123;<br>        error();<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>    &#125;<br><br>    G = EC_POINT_new(group);<br>    P = EC_POINT_new(group);<br>    P1 = EC_POINT_new(group);<br><br>    <span class="hljs-comment">// set P1 = (p1x, p1y)</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-number">1</span> != EC_POINT_set_affine_coordinates_GFp(group, P1, p1x, p1y, bn_ctx)) &#123;<br>        error();<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>    &#125;<br><br>    <span class="hljs-comment">//P = ((d2)^(-1)) * P1 - G</span><br>    <span class="hljs-keyword">if</span> (!BN_zero(tmp1) ||<br>        !BN_one(tmp2) ||<br>        !BN_mod_sub(negone, tmp1, tmp2, n, bn_ctx)<br>    ) &#123;<br>        error();<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (!BN_mod_inverse(tmp1, d2, n, bn_ctx) || !EC_POINT_mul(group, P, negone, P1, tmp1, bn_ctx)) &#123;<br>        error();<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (!EC_POINT_get_affine_coordinates_GFp(group, P, px, py, bn_ctx)) &#123;<br>        error();<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>    &#125;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Px: %s\n&quot;</span>, BN_bn2hex(px));<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Py: %s\n&quot;</span>, BN_bn2hex(py));<br><br>    rv = <span class="hljs-number">0</span>;<br>    BN_CTX_free(bn_ctx);<br><br>    <span class="hljs-keyword">return</span> rv;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> *argv[])</span> &#123;<br>    <span class="hljs-type">int</span> rv = <span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">if</span> (server(argv[<span class="hljs-number">1</span>], argv[<span class="hljs-number">2</span>], argv[<span class="hljs-number">3</span>], argv[<span class="hljs-number">4</span>], argv[<span class="hljs-number">5</span>], argv[<span class="hljs-number">6</span>], argv[<span class="hljs-number">7</span>])) &#123;<br>        error();<br>        <span class="hljs-keyword">return</span> rv;<br>    &#125;<br><br>    rv = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">return</span> rv;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>这一题要求是把d2给求出来，我们知道</p>
<p>$s_2 &#x3D; d_2 * k_3  (mod n)$</p>
<p>$ s_3 &#x3D; d_2 * (r+k_2) (mod n)$</p>
<p>关键在于</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">BN_copy(k3, k2)<br></code></pre></td></tr></table></figure>

<p>所以显然d2是可以解出来的</p>
<p>$(s_3-s_2)*r^{-1}&#x3D;d_2(mod n)$</p>
<p>非常简单。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python">r=<span class="hljs-number">0xB9D9723CBD74689FE2CAD8BEA57DE7158202D0890F72FA611403871BC7377DDA</span><br>s2 = <span class="hljs-number">0x02A20FDB2CDA53DF42F73E5C2FEADEC1E490C429779826405455E0720AE2F909</span><br>s3 = <span class="hljs-number">0x3348A503A5A5CD3E9ED119232B82374CCF7411BFBEA1A3B2F3CA6CD5281BC917</span><br>n = <span class="hljs-number">0xFFFFFFFEFFFFFFFFFFFFFFFFFFFFFFFF7203DF6B21C6052B53BBF40939D54123</span><br><span class="hljs-keyword">from</span> Crypto.Util.number <span class="hljs-keyword">import</span> inverse<br><br>d2 = ((s3 - s2) * inverse(r, n)) % n<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(d2))<br></code></pre></td></tr></table></figure>

<h4 id="flag3"><a href="#flag3" class="headerlink" title="flag3"></a>flag3</h4><p>生成一个公私钥对，用公钥注册，复制签名公钥得到的证书进行登录，但是登录用户名写 shangmibeiadmin 就能拿到 flag3。</p>
<p>当时是队友直接去gmssl的test.py找的一个公私钥对，现在想想还是有点难绷。</p>
<p>（暂无截图，大概就是一个简单的交互界面，要求给用户名和证书</p>
<h4 id="flag4"><a href="#flag4" class="headerlink" title="flag4"></a>flag4</h4><p>然后得到一个总经理.zip，要求解开加密的流量，flag4就在流量里。</p>
<p>题目：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> gmssl.sm4 <span class="hljs-keyword">import</span> CryptSM4, SM4_ENCRYPT, SM4_DECRYPT<br><br>MULTIPLIER = <span class="hljs-number">6364136223846793005</span><br>ADDEND = <span class="hljs-number">1</span><br>MASK = <span class="hljs-number">0xffffffffffffffff</span><br>ITERATIONS = <span class="hljs-number">1000</span><br><br><span class="hljs-comment"># 从文件中读取seed</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">read_seed</span>(<span class="hljs-params">file_path</span>):<br>    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(file_path, <span class="hljs-string">&#x27;r&#x27;</span>) <span class="hljs-keyword">as</span> file:<br>        seed = <span class="hljs-built_in">int</span>(file.read().strip(), <span class="hljs-number">16</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;seed:&quot;</span>, <span class="hljs-built_in">hex</span>(seed))<br>    <span class="hljs-keyword">return</span> seed<br><br>global_seed = read_seed(<span class="hljs-string">&#x27;seed.txt&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">genRandom</span>():<br>    <span class="hljs-keyword">global</span> global_seed<br>    <span class="hljs-comment"># print(&quot;global_seed&quot;, hex(global_seed))</span><br>    <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(ITERATIONS):<br>        global_seed = (global_seed * MULTIPLIER + ADDEND) &amp; MASK<br>    <span class="hljs-keyword">return</span> (global_seed &gt;&gt; <span class="hljs-number">32</span>) &amp; <span class="hljs-number">0xffffffff</span><br><br><span class="hljs-comment"># 16进制字符串转bytes</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">HexStringToBytes</span>(<span class="hljs-params">hex_str</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">bytes</span>.fromhex(hex_str)<br><br><span class="hljs-comment"># bytes转16进制字符串</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">BytesToHexString</span>(<span class="hljs-params">byte_seq</span>):<br>    <span class="hljs-keyword">return</span> byte_seq.<span class="hljs-built_in">hex</span>()<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">genSM4KeyOrIV</span>():<br>    <span class="hljs-keyword">return</span> HexStringToBytes(<span class="hljs-string">&#x27;&#x27;</span>.join(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;genRandom():08x&#125;</span>&#x27;</span> <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">4</span>)))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">SM4Encrypt</span>(<span class="hljs-params">data_bytes, key_bytes, iv_bytes</span>):<br>    sm4 = CryptSM4()<br>    sm4.set_key(key_bytes, SM4_ENCRYPT)<br>    <span class="hljs-keyword">return</span> sm4.crypt_cbc(iv_bytes, data_bytes)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">SM4Decrypt</span>(<span class="hljs-params">cipher_bytes, key_bytes, iv_bytes</span>):<br>    sm4 = CryptSM4()<br>    sm4.set_key(key_bytes, SM4_DECRYPT)<br>    <span class="hljs-keyword">return</span> sm4.crypt_cbc(iv_bytes, cipher_bytes)<br><br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;############ SM4 Cryptographic Services Start... ###################&quot;</span>)<br><br>iv_bytes = genSM4KeyOrIV()<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;iv hex:&quot;</span>, BytesToHexString(iv_bytes))<br><br>key_bytes = genSM4KeyOrIV()<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;key hex:&quot;</span>, BytesToHexString(key_bytes))<br><br><span class="hljs-comment"># 从test.pcapng读取数据并加密</span><br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;test.pcapng&#x27;</span>, <span class="hljs-string">&#x27;rb&#x27;</span>) <span class="hljs-keyword">as</span> f1:<br>    plain1_bytes = f1.read()<br>    cipher1_bytes = SM4Encrypt(plain1_bytes,key_bytes,iv_bytes)<br><br><span class="hljs-comment"># 写密文数据到cipherText.dat</span><br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;cipherText.dat&#x27;</span>, <span class="hljs-string">&#x27;wb&#x27;</span>) <span class="hljs-keyword">as</span> f2:<br>    f2.write(cipher1_bytes)<br><br><span class="hljs-comment"># 从cipherText.dat读密文数据</span><br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;cipherText.dat&#x27;</span>, <span class="hljs-string">&#x27;rb&#x27;</span>) <span class="hljs-keyword">as</span> f3:<br>    cipher2_bytes = f3.read()<br>    plain2_bytes = SM4Decrypt(cipher2_bytes,key_bytes,iv_bytes)<br><br><span class="hljs-comment"># 解密密文并将明文写入到plainText.pcapng(含flag4)</span><br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;plainText.pcapng&#x27;</span>, <span class="hljs-string">&#x27;wb&#x27;</span>) <span class="hljs-keyword">as</span> f4:<br>    f4.write(plain2_bytes)<br></code></pre></td></tr></table></figure>

<p>可以发现，iv和key的生成依赖线性同余，但是如果要爆破可能的随机数种子需要爆破2**32，最后当然是狠狠的爆破了（</p>
<p>（爆破没什么好写的就不写了</p>
<p><img src="/../pic/image-20240905145811936.png" srcset="/img/loading.gif" lazyload alt="image-20240905145811936"></p>
<p>最后得到flag4</p>
<h4 id="最终挑战"><a href="#最终挑战" class="headerlink" title="最终挑战"></a>最终挑战</h4><p>最终挑战，给定一个消息摘要，要求伪造总经理的签名。</p>
<p>其实我们有两个方程，d1和k1都是算得出来的。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># n = 0xFFFFFFFEFFFFFFFFFFFFFFFFFFFFFFFF7203DF6B21C6052B53BBF40939D54123</span><br><span class="hljs-comment"># G = GF(n)</span><br><span class="hljs-comment"># P.&lt;x,y&gt; = PolynomialRing(G, order=&#x27;lex&#x27;)</span><br><span class="hljs-comment"># # x = d1</span><br><span class="hljs-comment"># # y = k1</span><br><span class="hljs-comment"># r1 = 0x8A6BB033033E79683E81FE36D6394262D451A3DB9D1A0C489D51543D22E67BC4</span><br><span class="hljs-comment"># e = 0xeaf0adee014bd35a12180bbc99292e3acf895203aa97f8dbbb760da04da844f6</span><br><span class="hljs-comment"># s1 = 0x47baaef61c7a3c4c239fc2634ec25a2059d937026c6e0b72df1463fbba5b3a05</span><br><span class="hljs-comment"># s = 0xcb524f49515c9a7387210ddcdbf1f32aad1c8806f01a362c62a5d6a5466da158</span><br><span class="hljs-comment"># s2 = 0xB54A6668F644EC08D925552D45F66E348762B460693E7A68CBB0FDF38327DB45</span><br><span class="hljs-comment"># s3 = 0xB50FAE013594F79192898FF7FC0A84D931B1EC56EF9174159023ACF1C708180D</span><br><span class="hljs-comment"># r = 0x8A6BB033033E79683E81FE36D6394262D451A3DB9D1A0C489D51543D22E67BC4</span><br><span class="hljs-comment"># I = Ideal([x * e + r1 - y * x * s1, s + r - x * y * s2 + x * s3])</span><br><br><span class="hljs-comment"># I.variety()</span><br><br><span class="hljs-comment"># d = &#123;x: 57380008957341971613717690318294399953338921752138841512102949164866741871341, y: 113664965550405303122855944928778451946027085473011499438955455126429316351741&#125;</span><br>d1 = <span class="hljs-number">57380008957341971613717690318294399953338921752138841512102949164866741871341</span><br>k1 = <span class="hljs-number">113664965550405303122855944928778451946027085473011499438955455126429316351741</span><br></code></pre></td></tr></table></figure>

<p>（这个结果应该是算的不对的 懒得再跑了</p>
<p>但是当时时间太紧，没看到用他给定的消息摘要值去伪造而是用了流量包里的。。</p>
<p>所以最后并没有做出来，最后的步骤大概是用给定的消息摘要值通过他的步骤去伪造这个签名，嗯。</p>
<p>如果后续找到别人的wp，会及时更新。</p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/CTF/" class="print-no-link">#CTF</a>
      
        <a href="/tags/Crypto/" class="print-no-link">#Crypto</a>
      
        <a href="/tags/Web/" class="print-no-link">#Web</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>2024-熵密杯-wp-Crypto</div>
      <div>https://py-thok.github.io/2024/09/05/2024-熵密杯-wp-Crypto/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>PYthok-Ptk</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2024年9月5日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2024/09/07/2024-%E4%BA%AC%E6%B4%A5%E5%86%80%E6%94%BB%E9%98%B2-wp-crypto/" title="2024-京津冀攻防-wp-crypto">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">2024-京津冀攻防-wp-crypto</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2024/07/11/2024-%E6%98%A5%E7%A7%8B%E6%9D%AF%E5%A4%8F%E5%AD%A3%E8%B5%9B-wp-crypto/" title="2024-春秋杯夏季赛-wp-crypto">
                        <span class="hidden-mobile">2024-春秋杯夏季赛-wp-crypto</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  
  
    <article id="comments" lazyload>
      
  <div id="twikoo"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#comments', function() {
      Fluid.utils.createScript('https://lib.baomitu.com/twikoo/1.6.8/twikoo.all.min.js', function() {
        var options = Object.assign(
          {"envId":"https://silver-crumble-1edb9d.netlify.app/.netlify/functions/twikoo","region":"ap-shanghai","path":"window.location.pathname"},
          {
            el: '#twikoo',
            path: 'window.location.pathname',
            onCommentLoaded: function() {
              Fluid.utils.listenDOMLoaded(function() {
                var imgSelector = '#twikoo .tk-content img:not(.tk-owo-emotion)';
                Fluid.plugins.imageCaption(imgSelector);
                Fluid.plugins.fancyBox(imgSelector);
              });
            }
          }
        )
        twikoo.init(options)
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  


  
  









    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        总访问量 
        <span id="busuanzi_value_site_pv"></span>
         次
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        总访客数 
        <span id="busuanzi_value_site_uv"></span>
         人
      </span>
    
    
  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  
      <script>
        if (!window.MathJax) {
          window.MathJax = {
            tex    : {
              inlineMath: { '[+]': [['$', '$']] }
            },
            loader : {
              load: ['ui/lazy']
            },
            options: {
              renderActions: {
                insertedScript: [200, () => {
                  document.querySelectorAll('mjx-container').forEach(node => {
                    let target = node.parentNode;
                    if (target.nodeName.toLowerCase() === 'li') {
                      target.parentNode.classList.add('has-jax');
                    }
                  });
                }, '', false]
              }
            }
          };
        } else {
          MathJax.startup.document.state(0);
          MathJax.texReset();
          MathJax.typeset();
          MathJax.typesetPromise();
        }

        Fluid.events.registerRefreshCallback(function() {
          if ('MathJax' in window && MathJax.startup.document && typeof MathJax.startup.document.state === 'function') {
            MathJax.startup.document.state(0);
            MathJax.texReset();
            MathJax.typeset();
            MathJax.typesetPromise();
          }
        });
      </script>
    

  <script  src="https://lib.baomitu.com/mathjax/3.2.2/es5/tex-mml-chtml.js" ></script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
